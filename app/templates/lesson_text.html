{# app/templates/lesson_text.html V1.12 - Relies on window.quizLogic #}
{% extends "base.html" %} {# 继承基础模板 #}

{# 设置页面标题 #}
{% block title %}Lesson {{ lesson.lesson_number }} - {{ lesson.title_en or 'Lesson Text' }}{% endblock %}

{% block content %}
{# --- 1. 增强型标题区域 --- #}
<div class="p-4 p-md-5 mb-4 rounded-3 bg-light shadow-sm border-start border-primary border-5">
    <div class="container-fluid py-3">
        <h1 class="display-5 fw-bold">Lesson {{ lesson.lesson_number }}: {{ lesson.title_en or 'Unknown Title' }}</h1>
        {% if lesson.title_cn %}
            <p class="fs-4 text-muted">{{ lesson.title_cn }}</p>
        {% endif %}
    </div>
</div>

{# --- 2. 英文课文、音频和录音主区域 --- #}
<div class="p-4 border rounded-3 bg-white shadow mb-4">
    <h3 class="mb-4 pb-2 border-bottom"><i class="bi bi-file-earmark-text-fill"></i> 英文课文与跟读练习</h3>

    {# --- 音频和录音控件行 --- #}
    <div class="row g-3 mb-4 align-items-center">
        {# 预生成音频播放器 #}
        <div class="col-md-6">
            {% if audio_url %}
                <div>
                    <label class="form-label small fw-bold">课程音频:</label>
                    <audio controls preload="metadata" class="w-100" title="播放预生成的课程音频">
                        <source src="{{ audio_url }}" type="audio/wav">
                        你的浏览器不支持播放 WAV 音频。
                    </audio>
                </div>
            {% else %}
                <div class="text-muted small"><i class="bi bi-exclamation-circle"></i> 暂无预生成音频。</div>
            {% endif %}
        </div>
        {# 用户录音控件 #}
        <div class="col-md-6">
             <div class="p-3 border rounded-2 bg-light-subtle h-100">
                <label class="form-label small fw-bold">跟读录音:</label>
                <div class="d-flex align-items-center mb-2">
                    <button id="record-button" class="btn btn-danger btn-sm me-2"><i class="bi bi-mic-fill"></i> 开始录音</button>
                    <span id="recording-status" class="text-muted small flex-grow-1"></span>
                </div>
                <div id="user-recording-playback" style="min-height: 40px;"></div>
            </div>
        </div>
    </div>

    {# --- 英文课文内容 --- #}
    {# 应用拟物化纸张样式 #}
    <div class="lesson-text english-text preserve-newlines border-top pt-3" id="english-text-content">
        {% if lesson.text_en %}
             {{ lesson.text_en }}
        {% else %}
            <p class="text-muted"><em>English text not available.</em></p>
        {% endif %}
    </div>
</div>
{# --- 英文区域结束 --- #}


{# --- 3. 操作按钮区域 --- #}
<div class="mb-4 pt-3 text-center border-top">
    <a href="{{ url_for('view_lessons') }}" class="btn btn-secondary me-2"><i class="bi bi-arrow-left-circle"></i> 返回课程列表</a>
    <button type="button" id="start-lesson-quiz-btn" class="btn btn-success" data-lesson-number="{{ lesson.lesson_number }}"><i class="bi bi-question-circle-fill"></i> 测试本课词汇</button>
</div>

{# --- 4. 隐藏的 Quiz 和 Results 区域 (供 quiz_logic.js 使用) --- #}
<div class="dynamic-content-area mt-4">
    <div id="quiz-area" class="hidden p-3 border rounded bg-light shadow-sm">
         <h2 class="text-center mb-4">Lesson {{ lesson.lesson_number }} 词汇测试进行中...</h2>
         <div id="questions-container"></div>
         <div class="text-center"><button type="button" id="submit-quiz-btn" class="btn btn-primary hidden mt-3">提交答案</button></div>
    </div>
    <div id="results-area" class="hidden mt-4 p-3 border rounded bg-light shadow-sm">
         <h2>测试结果</h2>
         <p>你的得分: <span id="score" class="fw-bold"></span> / <span id="total-questions"></span></p>
         <h3 id="incorrect-title">错题回顾:</h3>
         <ul id="incorrect-list" class="list-group list-group-flush mb-3"></ul>
         <button type="button" id="restart-quiz-btn" class="btn btn-info hidden">重新测试本课 (Quiz Again)</button>
    </div>
    <div id="loading-indicator" class="hidden mt-4 text-center">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="text-muted mt-2">请稍候...</p>
    </div>
     <div id="error-message" class="alert alert-danger hidden mt-4" role="alert"></div>
</div>
{# --- 隐藏区域结束 --- #}

{# --- 5. 中文参考译文区域 (默认显示) --- #}
{% if lesson.text_cn %}
<hr class="my-4">
<div class="translation-section">
    <div id="collapseTranslation">
      <div class="card card-body bg-light border-secondary">
          <h5 class="card-title text-muted">参考译文 (Translation)</h5>
          <div class="lesson-text chinese-text preserve-newlines small">
                {% set cn_paragraphs = lesson.text_cn.split('\n') %}
                {% for para in cn_paragraphs %}{% if para.strip() %}<p class="mb-2">{{ para }}</p>{% endif %}{% endfor %}
          </div>
      </div>
    </div>
</div>
{% endif %}
{# --- 中文区域结束 --- #}

{% endblock %}

{# --- 特定页面 CSS (修正背景平铺问题) --- #}
{% block styles_extra %}
<style>
    /* --- 整体页面背景优化 (示例) --- */
    /* body { background: linear-gradient(to bottom right, #e0f7fa, #b2ebf2); background-attachment: fixed; } */

    /* --- 内容区域容器的微调 (示例) --- */
     .rounded-3.bg-white.shadow,
     .rounded-3.bg-light.shadow-sm,
     .translation-section .card {
        box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1) !important;
        border-color: rgba(0, 0, 0, 0.08) !important;
     }

    /* === 主题 3: 拟物化“纸张”效果 (修正背景) === */
    .lesson-text.english-text {
        background-color: #fefefe; /* 纸张的底色 */
        background-image: url('{{ url_for("static", filename="images/lesson.png") }}'); /* 纸张纹理 */

        /* --- 修改开始 --- */
        background-repeat: no-repeat;  /* 禁止背景图片重复平铺 */
        background-size: cover;      /* 让背景图片缩放以完全覆盖元素区域 */
                                     /* 保持图片的宽高比，可能会裁剪掉部分图片 */
        background-position: center center; /* 图片居中显示，裁剪时优先保留中间部分 */
        /* --- 修改结束 --- */

        color: #222; /* 更深的文字颜色 */
        font-family: 'Playfair Display', serif; /* 更具艺术感的字体 (需引入) */
        font-size: 1.15rem;
        line-height: 1.9;
        letter-spacing: 0.03em;

        padding: 2.5rem; /* 纸张边缘的留白 */

        border-radius: 8px; /* 纸张的圆角 */
        box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.15), 0 0 10px rgba(0, 0, 0, 0.05) inset; /* 内外阴影 */

        white-space: pre-line; /* 保留换行符 */
        position: relative;
        overflow: hidden; /* 隐藏超出边界的背景图部分 */
    }
    /* === 主题 3 结束 === */


    /* --- 中文参考译文样式 --- */
    .chinese-text p { margin-bottom: 0.5em; line-height: 1.6; }

    /* --- 其他通用样式 --- */
    .translation-section .card-title { font-size: 1rem; }
    .border-5 { border-width: 5px !important; }
    .preserve-newlines { white-space: pre-line; }
    .dynamic-content-area { min-height: 200px; }
    .hidden { display: none !important; }
    .recording-indicator::before { /* ... */ }
    @keyframes blink { /* ... */ }

    /* 提醒：字体引入 */
</style>
{% endblock %}

{# --- 特定页面 JS (最终版，依赖 window.quizLogic) --- #}
{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log('lesson_text.html: DOM fully loaded (for speech/recording/quiz init)');

        try { /* --- 语音合成初始化 --- */
            if ('speechSynthesis' in window) { /* ... */ } else { /* ... */ }
             console.log("lesson_text.html: Speech setup attempted.");
        } catch (speechError) { console.error(speechError); }

        try { /* --- 录音功能初始化 --- */
             if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) { /* ... */ } else { /* ... */ }
             console.log("lesson_text.html: Recording setup attempted.");
        } catch (recordError) { console.error(recordError); }

        // --- 测验逻辑初始化 ---
         console.log("lesson_text.html: Initializing lesson quiz logic...");
         initializeLessonQuizLogic(); // 直接调用

    }); // --- End of DOMContentLoaded listener ---


    // --- 将所有测验相关的初始化代码放入一个函数 ---
    function initializeLessonQuizLogic() {
        // --- 检查 quiz_logic.js 是否已加载并暴露函数 ---
        if (typeof window.quizLogic === 'undefined' || typeof window.quizLogic.resetQuizUI !== 'function') {
            console.error("lesson_text.html: CRITICAL - window.quizLogic object or functions not found!");
            alert("加载核心测验组件失败，请刷新页面并检查浏览器控制台。");
            const startBtn = document.getElementById('start-lesson-quiz-btn'); if(startBtn) startBtn.disabled = true;
            const restartBtn = document.getElementById('restart-quiz-btn'); if(restartBtn) restartBtn.disabled = true;
            return; // Stop initialization
        }
        console.log("lesson_text.html: window.quizLogic confirmed. Proceeding.");

        // --- 获取本页按钮 ---
        const startLessonQuizBtn = document.getElementById('start-lesson-quiz-btn');
        const restartQuizBtn = document.getElementById('restart-quiz-btn'); // 在 results-area 内

        // --- 定义启动本课测验的函数 ---
        async function startLessonQuizLocal(lessonNumber) {
            if (!lessonNumber) { console.error("No lesson number provided."); window.quizLogic.showError('无法获取课程编号。'); return; }
            console.log(`lesson_text.html: Starting quiz for lesson ${lessonNumber}`);

            // 调用全局函数重置/显示加载
            window.quizLogic.resetQuizUI();
            window.quizLogic.showLoading(true);
            if (startLessonQuizBtn) startLessonQuizBtn.disabled = true;

            const numQuestions = 10; const quizType = 'cn_to_en';

            // 设置全局状态 (在 quiz_logic.js 中定义)
            quizContext = { lesson_ids: [parseInt(lessonNumber)], quiz_type: quizType, question_ids: [] };
            console.log("lesson_text.html: Quiz context set:", quizContext);

            try {
                const response = await fetch(`/api/quiz?lessons=${lessonNumber}&count=${numQuestions}&type=${quizType}`);
                window.quizLogic.showLoading(false);
                if (!response.ok) { let eMsg=`加载题目失败(${response.status})`; try{const d=await response.json();eMsg=d.error||eMsg;}catch(e){} throw new Error(eMsg); }

                // 设置全局状态 (在 quiz_logic.js 中定义)
                currentQuizData = await response.json();

                if (!currentQuizData || currentQuizData.length === 0) { window.quizLogic.showError(`未能加载 Lesson ${lessonNumber} 的词汇题。`); if (startLessonQuizBtn) startLessonQuizBtn.disabled = false; return; }

                // 更新全局状态
                quizContext.question_ids = currentQuizData.map(q => q.id);
                console.log("lesson_text.html: Quiz data loaded, question IDs:", quizContext.question_ids);

                // 调用全局函数显示问题
                window.quizLogic.displayQuestions();

            } catch (error) {
                console.error('lesson_text.html: Error starting lesson quiz:', error);
                window.quizLogic.showError(`开始测试失败: ${error.message}`); // 显示错误
                if (startLessonQuizBtn) startLessonQuizBtn.disabled = false; // 重新启用开始按钮
                window.quizLogic.showLoading(false); // 确保 loading 隐藏
            }
        }

        // --- 定义重启本课测验的函数 ---
        function restartLessonQuizLocal() {
            console.log("lesson_text.html: Restarting quiz for this lesson...");
            window.quizLogic.resetQuizUI(); // 调用全局重置函数
            // UI is reset, user needs to click "测试本课词汇" again
        }

        // --- 为按钮绑定事件 ---
        if (startLessonQuizBtn) {
            startLessonQuizBtn.addEventListener('click', () => {
                const lessonNum = startLessonQuizBtn.dataset.lessonNumber;
                startLessonQuizLocal(lessonNum);
            });
            console.log("lesson_text.html: Event listener attached to startLessonQuizBtn.");
        } else { console.warn("lesson_text.html: Start Lesson Quiz button not found."); }

        if (restartQuizBtn) {
             restartQuizBtn.addEventListener('click', restartLessonQuizLocal);
             console.log("lesson_text.html: Event listener attached to restartQuizBtn.");
        } else { console.warn("lesson_text.html: Restart button not found (might be initially hidden)."); }

    } // --- End of initializeLessonQuizLogic ---
</script>
{% endblock %}