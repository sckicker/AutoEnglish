{# app/templates/lesson_text.html V1.14 - Integrated Recording & Improved Quiz Logic Interaction #}
{% extends "base.html" %} {# 继承基础模板 #}

{# 设置页面标题 #}
{% block title %}Lesson {{ lesson.lesson_number }} - {{ lesson.title_en or 'Lesson Text' }}{% endblock %}

{% block content %}
{# --- 1. 增强型标题区域 --- #}
<div class="p-4 p-md-5 mb-4 rounded-3 bg-light shadow-sm border-start border-primary border-5">
    <div class="container-fluid py-3">
        <h1 class="display-5 fw-bold">Lesson {{ lesson.lesson_number }}: {{ lesson.title_en or 'Unknown Title' }}</h1>
        {% if lesson.title_cn %}
            <p class="fs-4 text-muted">{{ lesson.title_cn }}</p>
        {% endif %}
    </div>
</div>

{# --- 2. 英文课文、音频和录音主区域 --- #}
<div class="p-4 border rounded-3 bg-white shadow mb-4">
    <h3 class="mb-4 pb-2 border-bottom"><i class="bi bi-file-earmark-text-fill"></i> 英文课文与跟读练习</h3>

    {# --- 音频和录音控件行 --- #}
    <div class="row g-3 mb-4 align-items-center">
        {# 预生成音频播放器 #}
        <div class="col-md-6">
            {% if audio_url %}
                <div>
                    <label class="form-label small fw-bold">课程音频:</label>
                    <audio controls preload="metadata" class="w-100" title="播放预生成的课程音频">
                        <source src="{{ audio_url }}" type="audio/wav">
                        你的浏览器不支持播放 WAV 音频。
                    </audio>
                </div>
            {% else %}
                <div class="text-muted small"><i class="bi bi-exclamation-circle"></i> 暂无预生成音频。</div>
            {% endif %}
        </div>
        {# 用户录音控件 #}
        <div class="col-md-6">
             <div class="p-3 border rounded-2 bg-light-subtle h-100">
                <label class="form-label small fw-bold">跟读录音:</label>
                <div class="d-flex align-items-center mb-2">
                    <button id="record-button" class="btn btn-danger btn-sm me-2"><i class="bi bi-mic-fill"></i> 开始录音</button>
                    <span id="recording-status" class="text-muted small flex-grow-1"></span>
                </div>
                <div id="user-recording-playback" style="min-height: 40px;"></div>
            </div>
        </div>
    </div>

    {# --- 英文课文内容 --- #}
    {# 应用拟物化纸张样式 #}
    <div class="lesson-text english-text preserve-newlines border-top pt-3" id="english-text-content">
        {% if lesson.text_en %}
             {{ lesson.text_en }}
        {% else %}
            <p class="text-muted"><em>English text not available.</em></p>
        {% endif %}
    </div>
</div>
{# --- 英文区域结束 --- #}


{# --- 3. 操作按钮区域 --- #}
<div class="mb-4 pt-3 text-center border-top">
    <a href="{{ url_for('view_lessons') }}" class="btn btn-secondary me-2"><i class="bi bi-arrow-left-circle"></i> 返回课程列表</a>
    <button type="button" id="start-lesson-quiz-btn" class="btn btn-success" data-lesson-number="{{ lesson.lesson_number }}"><i class="bi bi-question-circle-fill"></i> 测试本课词汇</button>
</div>

{# --- 4. 隐藏的 Quiz 和 Results 区域 (供 quiz_logic.js 使用) --- #}
<div class="dynamic-content-area mt-4">
    <div id="quiz-area" class="hidden p-3 border rounded bg-light shadow-sm">
         <h2 class="text-center mb-4">Lesson {{ lesson.lesson_number }} 词汇测试进行中...</h2>
         <div id="questions-container"></div>
         {# Note: submit-quiz-btn listener is attached by quiz_logic.js #}
         <div class="text-center"><button type="button" id="submit-quiz-btn" class="btn btn-primary hidden mt-3">提交答案</button></div>
    </div>
    <div id="results-area" class="hidden mt-4 p-3 border rounded bg-light shadow-sm">
         <h2>测试结果</h2>
         <p>你的得分: <span id="score" class="fw-bold"></span> / <span id="total-questions"></span></p>
         <h3 id="incorrect-title">错题回顾:</h3>
         <ul id="incorrect-list" class="list-group list-group-flush mb-3"></ul>
         <button type="button" id="restart-quiz-btn" class="btn btn-info hidden">重新测试本课 (Quiz Again)</button>
    </div>
    <div id="loading-indicator" class="hidden mt-4 text-center">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="text-muted mt-2">请稍候...</p>
    </div>
     <div id="error-message" class="alert alert-danger hidden mt-4" role="alert"></div>
</div>
{# --- 隐藏区域结束 --- #}

{# --- 5. 中文参考译文区域 (默认显示) --- #}
{% if lesson.text_cn %}
<hr class="my-4">
<div class="translation-section">
    <div id="collapseTranslation">
      <div class="card card-body bg-light border-secondary">
          <h5 class="card-title text-muted">参考译文 (Translation)</h5>
          <div class="lesson-text chinese-text preserve-newlines small">
                {% set cn_paragraphs = lesson.text_cn.split('\n') %}
                {% for para in cn_paragraphs %}{% if para.strip() %}<p class="mb-2">{{ para }}</p>{% endif %}{% endfor %}
          </div>
      </div>
    </div>
</div>
{% endif %}
{# --- 中文区域结束 --- #}

{% endblock %}

{# --- 特定页面 CSS (修正背景平铺问题) --- #}
{% block styles_extra %}
<style>
    /* --- 整体页面背景优化 (示例) --- */
    /* body { background: linear-gradient(to bottom right, #e0f7fa, #b2ebf2); background-attachment: fixed; } */

    /* --- 内容区域容器的微调 (示例) --- */
     .rounded-3.bg-white.shadow,
     .rounded-3.bg-light.shadow-sm,
     .translation-section .card {
        box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1) !important;
        border-color: rgba(0, 0, 0, 0.08) !important;
     }

    /* === 主题 3: 拟物化“纸张”效果 (修正背景) === */
    .lesson-text.english-text {
        background-color: #fefefe; /* 纸张的底色 */
        background-image: url('{{ url_for("static", filename="images/lesson.png") }}'); /* 纸张纹理 */

        /* --- 修改开始 --- */
        background-repeat: no-repeat;  /* 禁止背景图片重复平铺 */
        background-size: cover;      /* 让背景图片缩放以完全覆盖元素区域 */
                                     /* 保持图片的宽高比，可能会裁剪掉部分图片 */
        background-position: center center; /* 图片居中显示，裁剪时优先保留中间部分 */
        /* --- 修改结束 --- */

        color: #222; /* 更深的文字颜色 */
        font-family: 'Playfair Display', serif; /* 更具艺术感的字体 (需引入) */
        font-size: 1.15rem;
        line-height: 1.9;
        letter-spacing: 0.03em;

        padding: 2.5rem; /* 纸张边缘的留白 */

        border-radius: 8px; /* 纸张的圆角 */
        box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.15), 0 0 10px rgba(0, 0, 0, 0.05) inset; /* 内外阴影 */

        white-space: pre-line; /* 保留换行符 */
        position: relative;
        overflow: hidden; /* 隐藏超出边界的背景图部分 */
    }
    /* === 主题 3 结束 === */


    /* --- 中文参考译文样式 --- */
    .chinese-text p { margin-bottom: 0.5em; line-height: 1.6; }

    /* --- 其他通用样式 --- */
    .translation-section .card-title { font-size: 1rem; }
    .border-5 { border-width: 5px !important; }
    .preserve-newlines { white-space: pre-line; }
    .dynamic-content-area { min-height: 200px; }
    .hidden { display: none !important; }
    .recording-indicator::before { /* ... */ }
    @keyframes blink { /* ... */ }

    /* 提醒：字体引入 */
</style>
{% endblock %}


{# --- 特定页面 JS (包含语音合成、录音、测验启动逻辑及互斥处理) --- #}
{% block scripts_extra %}
<script>
    // --- Specific Page Script Starts ---
    console.log('lesson_text.html: Script block reached');

    // --- 全局变量，用于跟踪状态 ---
    let isCurrentlyRecording = false; // 跟踪录音状态
    let isCurrentlySpeaking = false; // 跟踪 TTS 朗读状态 (如果使用 TTS)
    let currentAudioElement = null; // 指向当前正在播放的 <audio> 元素 (预生成或录音)
    let mediaRecorderInstance = null; // 持有 MediaRecorder 实例
    let mediaStreamInstance = null;  // 持有麦克风流
    let recordedAudioChunks = []; // 持有录音数据块

    // --- DOMContentLoaded Listener: Ensures HTML is loaded before running JS ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log('lesson_text.html: DOM fully loaded');

        // 获取页面元素
        const recordButton = document.getElementById('record-button');
        const recordingStatus = document.getElementById('recording-status');
        const audioPlaybackContainer = document.getElementById('user-recording-playback');
        const preGeneratedAudio = document.querySelector('#lesson-audio-player audio'); // 获取预生成音频播放器
        const speakButton = document.getElementById('speak-button'); // TTS 朗读按钮
        const voiceSelect = document.getElementById('voice-select'); // TTS 语音选择
        const textToSpeakElement = document.getElementById('english-text-content'); // 要朗读的文本
        const startLessonQuizBtn = document.getElementById('start-lesson-quiz-btn'); // 测验按钮
        const restartQuizBtn = document.getElementById('restart-quiz-btn'); // 重新测验按钮 (在 results area 内)

        // --- 初始化录音逻辑 ---
        try {
            if (recordButton && recordingStatus && audioPlaybackContainer) {
                initializeRecordingLogic(recordButton, recordingStatus, audioPlaybackContainer, preGeneratedAudio, speakButton); // 传递相关按钮/元素
                console.log("lesson_text.html: Recording setup attempted.");
            } else {
                console.warn("Recording elements incomplete. Recording disabled.");
                if(recordButton) recordButton.disabled = true; // 如果元素不全则禁用按钮
            }
        } catch (recordError) { console.error("Recording Init Error:", recordError); }

        // --- 初始化语音合成逻辑 ---
        try {
            if (speakButton && textToSpeakElement && voiceSelect) {
                initializeSpeechSynthesis(speakButton, voiceSelect, textToSpeakElement, recordButton, preGeneratedAudio); // 传递相关按钮/元素
                console.log("lesson_text.html: Speech setup attempted.");
            } else {
                 console.log("lesson_text.html: Speech synthesis elements not found or incomplete, TTS disabled.");
                 if(speakButton) speakButton.disabled = true; // 如果元素不全则禁用按钮
                 if(voiceSelect) voiceSelect.disabled = true;
            }
        } catch (speechError) { console.error("Speech Init Error:", speechError); }


        // --- 初始化课程测验逻辑 ---
        try {
            // 测验逻辑需要启动按钮和重启按钮
            if(startLessonQuizBtn){
                initializeLessonQuizLogic(startLessonQuizBtn, restartQuizBtn); // Pass buttons
                console.log("lesson_text.html: Lesson quiz logic setup attempted.");
            } else {
                 console.warn("Start Lesson Quiz button not found. Quiz init skipped.");
            }
        } catch (quizError) { console.error("Quiz Init Error:", quizError); }

        // --- 为预生成的音频添加播放事件监听 ---
        if (preGeneratedAudio) {
            preGeneratedAudio.addEventListener('play', () => {
                console.log("Pre-generated audio started playing.");
                currentAudioElement = preGeneratedAudio; // 标记当前播放的是它

                 // 如果此时正在录音，则停止录音
                if (isCurrentlyRecording && mediaRecorderInstance && mediaRecorderInstance.state === 'recording') {
                    console.log("Audio play detected while recording. Stopping recording.");
                    stopRecording(recordButton, recordingStatus); // 调用停止录音的辅助函数
                }
                 // 如果 TTS 正在朗读，停止 TTS
                 if (window.speechSynthesis && window.speechSynthesis.speaking) {
                     console.log("Audio play detected while speaking. Stopping speech.");
                     window.speechSynthesis.cancel();
                     isCurrentlySpeaking = false; // 更新状态
                     // 可选：更新 TTS 按钮状态
                     if(speakButton) speakButton.innerHTML = '<i class="bi bi-play-fill"></i> 朗读';
                 }
            });
             preGeneratedAudio.addEventListener('pause', () => {
                 if (currentAudioElement === preGeneratedAudio) {
                      console.log("Pre-generated audio paused/stopped.");
                      currentAudioElement = null;
                 }
             });
             preGeneratedAudio.addEventListener('ended', () => {
                 if (currentAudioElement === preGeneratedAudio) {
                      console.log("Pre-generated audio ended.");
                      currentAudioElement = null;
                 }
             });
             console.log("Event listeners attached to pre-generated audio player.");
        } else {
             console.log("Pre-generated audio player not found.");
        }

    }); // --- End of DOMContentLoaded listener ---


    // ======================================
    // === Speech Synthesis Initialization (带互斥逻辑) ===
    // ======================================
    function initializeSpeechSynthesis(speakButton, voiceSelect, textToSpeakElement, recordButton, preGeneratedAudio) {
        // 检查依赖元素
        if (!speakButton || !textToSpeakElement || !voiceSelect) {
             console.warn("Cannot initialize Speech Synthesis: Required elements missing.");
             return;
        }
        if ('speechSynthesis' in window) {
            const synth = window.speechSynthesis;
            let voices = [];

            function populateVoiceList() {
                 try {
                     voices = synth.getVoices();
                     voiceSelect.innerHTML = ''; // Clear
                     let defaultSelected = false;
                     voices.forEach((voice) => {
                         if (voice.lang.startsWith('en')) { // Filter for English
                             const option = document.createElement('option');
                             option.textContent = `${voice.name} (${voice.lang})`;
                             option.value = voice.name;
                             option.setAttribute('data-lang', voice.lang);
                             option.setAttribute('data-name', voice.name);
                             // Attempt to select a default US/GB voice
                             if (!defaultSelected && (voice.lang === 'en-US' || voice.lang === 'en-GB') && voice.default) {
                                 option.selected = true;
                                 defaultSelected = true;
                             }
                             voiceSelect.appendChild(option);
                         }
                     });
                     // Fallback default selection if no default marked
                     if (!defaultSelected && voiceSelect.options.length > 0) {
                          const firstUS = Array.from(voiceSelect.options).find(opt => opt.dataset.lang === 'en-US');
                          if (firstUS) firstUS.selected = true;
                          else voiceSelect.options[0].selected = true;
                     }
                 } catch (e) { console.error("Error populating voice list:", e); }
            }

            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }

            speakButton.addEventListener('click', () => {
                // --- 互斥检查 ---
                stopPlaybackAndRecording(recordButton, preGeneratedAudio); // 调用统一停止函数
                // ----------------

                if (synth.speaking) {
                    console.log("Stopping previous speech.");
                    synth.cancel(); // 调用 cancel 会触发 onend 或 onerror
                    isCurrentlySpeaking = false;
                    speakButton.innerHTML = '<i class="bi bi-play-fill"></i> 朗读'; // 恢复按钮状态
                    // Don't return immediately, allow starting new speech
                }

                const textToSpeak = textToSpeakElement.textContent || textToSpeakElement.innerText;
                if (!textToSpeak) { console.warn("No text content found to speak."); return; }

                const utterThis = new SpeechSynthesisUtterance(textToSpeak);
                const selectedOption = voiceSelect.selectedOptions[0];
                const selectedVoiceName = selectedOption ? selectedOption.value : null;
                const selectedVoice = selectedVoiceName ? voices.find(voice => voice.name === selectedVoiceName) : null;

                if (selectedVoice) {
                    utterThis.voice = selectedVoice;
                    utterThis.lang = selectedVoice.lang;
                } else { console.warn("Selected voice not found, using browser default."); }

                utterThis.pitch = 1; utterThis.rate = 1;

                utterThis.onstart = () => { console.log("Speech started."); isCurrentlySpeaking = true; speakButton.innerHTML = '<i class="bi bi-stop-fill"></i> 停止'; }; // 更新按钮
                utterThis.onend = () => { console.log("Speech finished or cancelled."); isCurrentlySpeaking = false; speakButton.innerHTML = '<i class="bi bi-play-fill"></i> 朗读'; }; // 恢复按钮
                utterThis.onerror = (event) => { console.error('Speech error:', event); isCurrentlySpeaking = false; speakButton.innerHTML = '<i class="bi bi-play-fill"></i> 朗读'; }; // 恢复按钮

                synth.speak(utterThis);
            });
            console.log("Speech synthesis initialized.");
        } else {
             console.warn("Speech Synthesis not supported by this browser.");
             speakButton.disabled = true; speakButton.title = '浏览器不支持';
             voiceSelect.disabled = true;
        }
    } // --- End of initializeSpeechSynthesis ---


    // ======================================
    // === Recording Logic Initialization ===
    // ======================================
    function initializeRecordingLogic(recordButton, recordingStatus, audioPlaybackContainer, preGeneratedAudio, speakButton) {
        // Check dependencies
        if (!recordButton || !recordingStatus || !audioPlaybackContainer) { console.warn("Recording elements missing."); if(recordButton) recordButton.disabled = true; return; }
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder) { recordingStatus.textContent = "浏览器不支持录音"; recordButton.disabled = true; return; }

        function updateRecordingUI(state) {
            isCurrentlyRecording = state === 'recording'; // Update global flag
            if (!recordButton || !recordingStatus) return; // Check if elements exist

            switch (state) {
                case 'idle':
                    recordButton.innerHTML = '<i class="bi bi-mic-fill"></i> 开始录音';
                    recordButton.classList.replace('btn-secondary', 'btn-danger');
                    recordingStatus.textContent = '';
                    recordButton.disabled = false;
                    break;
                case 'recording':
                    recordButton.innerHTML = '<i class="bi bi-stop-fill"></i> 停止录音';
                    recordButton.classList.replace('btn-danger', 'btn-secondary');
                    recordingStatus.textContent = '正在录音...';
                    recordButton.disabled = false;
                    break;
                case 'stopping':
                    recordButton.innerHTML = '<i class="bi bi-hourglass-split"></i> 停止中...';
                    recordButton.disabled = true;
                    recordingStatus.textContent = '处理录音中...';
                    break;
                case 'unavailable':
                    recordButton.innerHTML = '<i class="bi bi-mic-mute-fill"></i> 无法录音';
                    recordButton.classList.replace('btn-danger', 'btn-secondary'); // Use secondary color for unavailable
                    recordButton.disabled = true;
                    recordingStatus.textContent = '麦克风不可用或权限被拒';
                    break;
                default:
                     console.warn("Unknown recording UI state:", state);
                     updateRecordingUI('idle'); // Fallback to idle
            }
        }

        recordButton.addEventListener('click', async () => {
            if (!isCurrentlyRecording) {
                // === Start Recording ===
                console.log("Attempting to start recording...");
                stopPlaybackAndRecording(recordButton, preGeneratedAudio, speakButton); // Stop other media first
                updateRecordingUI('stopping'); // Show preparing state

                try {
                    mediaStreamInstance = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const options = { mimeType: 'audio/webm' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) { options.mimeType = 'audio/ogg'; }
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) { options.mimeType = 'audio/wav'; }
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) { throw new Error('No supported audio MIME type.'); }
                    console.log("Recording using MIME type:", options.mimeType);

                    mediaRecorderInstance = new MediaRecorder(mediaStreamInstance, options);
                    recordedAudioChunks = [];

                    mediaRecorderInstance.ondataavailable = event => { if (event.data.size > 0) recordedAudioChunks.push(event.data); };

                    mediaRecorderInstance.onstop = () => {
                        console.log("Recording stopped. Chunks:", recordedAudioChunks.length);
                        const currentStream = mediaStreamInstance;
                        if (currentStream) currentStream.getTracks().forEach(track => track.stop());
                        mediaStreamInstance = null;

                        if (recordedAudioChunks.length === 0) { console.warn("No data recorded."); recordingStatus.textContent = "录音数据为空。"; updateRecordingUI('idle'); return; }
                        let success = false;
                        try {
                            const audioBlob = new Blob(recordedAudioChunks, { type: mediaRecorderInstance.mimeType });
                            if (audioBlob.size === 0) throw new Error("Blob size is 0.");
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const audioElement = document.createElement('audio');
                            audioElement.controls = true; audioElement.src = audioUrl; audioElement.title = "你的录音"; audioElement.classList.add("w-100", "mt-2");
                            audioElement.onplay = () => { currentAudioElement = audioElement; stopOtherMedia(audioElement, recordButton, preGeneratedAudio, speakButton); }; // Stop others when playback starts
                            audioElement.onpause = () => { if(currentAudioElement === audioElement) currentAudioElement = null; };
                            audioElement.onended = () => { if(currentAudioElement === audioElement) currentAudioElement = null; };

                            audioPlaybackContainer.innerHTML = '';
                            audioPlaybackContainer.appendChild(audioElement);
                            console.log("Audio element appended.");
                            success = true;
                        } catch (error) { console.error("Error processing recorded audio:", error); recordingStatus.textContent = `处理失败: ${error.message}`; }
                        finally { recordedAudioChunks = []; updateRecordingUI('idle'); } // Reset UI and chunks
                    };

                    mediaRecorderInstance.onerror = event => { console.error("MediaRecorder error:", event.error); updateRecordingUI('unavailable'); if (mediaStreamInstance) mediaStreamInstance.getTracks().forEach(track => track.stop()); mediaStreamInstance = null; };

                    mediaRecorderInstance.start();
                    console.log("Recording started.");
                    updateRecordingUI('recording');

                } catch (err) {
                    console.error('Mic access/start recording failed:', err);
                    updateRecordingUI('unavailable'); recordingStatus.textContent = `无法访问麦克风: ${err.name || err.message}`;
                    if (mediaStreamInstance) { mediaStreamInstance.getTracks().forEach(track => track.stop()); mediaStreamInstance = null; }
                    updateRecordingUI('idle'); // Try resetting to idle after error display
                }
            } else {
                // === Stop Recording ===
                stopRecording(recordButton, recordingStatus);
            }
        });
        updateRecordingUI('idle'); // Set initial state
        console.log("Recording logic initialized.");
    } // --- End of initializeRecordingLogic ---


    // ============================================
    // === Lesson Quiz Logic Initialization ===
    // ============================================
    function initializeLessonQuizLogic(startLessonQuizBtn, restartQuizBtn) {
        console.log("lesson_text.html: Running initializeLessonQuizLogic...");
        // --- Check if window.quizLogic is available ---
        if (typeof window.quizLogic === 'undefined' || /* ... (Rest of checks) ... */ false) {
            console.error("lesson_text.html: CRITICAL - window.quizLogic object or required functions/elements not found!");
            alert("加载核心测验组件失败..."); if(startLessonQuizBtn) startLessonQuizBtn.disabled = true; return;
        }
        console.log("lesson_text.html: window.quizLogic confirmed.");

        // --- Get THIS page's specific quiz buttons ---
        // Passed as arguments now

        // --- Function to start quiz FOR THIS LESSON ---
        async function startLessonQuizLocal(lessonNumber) { /* ... (保持之前的最新版本不变) ... */
            if (!lessonNumber) { console.error("No lesson number."); window.quizLogic.showError('无法获取课程编号。'); return; }
            console.log(`[1] Starting quiz for Lesson ${lessonNumber}...`);
            window.quizLogic.resetQuizUI();
            window.quizLogic.showLoading(true);
            if (startLessonQuizBtn) startLessonQuizBtn.disabled = true;
            const numQuestions = 999; const quizType = 'cn_to_en';
            if (typeof window.quizContext !== 'object' || window.quizContext === null) { window.quizContext = { lesson_ids: [], quiz_type: "", question_ids: [] }; } // Defensive init
            window.quizContext.lesson_ids = [parseInt(lessonNumber)]; window.quizContext.quiz_type = quizType; window.quizContext.question_ids = [];
            console.log("[2] Global quizContext set:", JSON.stringify(window.quizContext));
            try {
                const apiUrl = `/api/quiz?lessons=${lessonNumber}&count=${numQuestions}&type=${quizType}`; console.log("[3] Fetching:", apiUrl);
                const response = await fetch(apiUrl); console.log("[4] Status:", response.status, "OK:", response.ok);
                if (!response.ok) { let eMsg = `加载题目失败 (${response.status})`; try { const txt = await response.text(); console.error("[5a] API Err Text:", txt); if(response.headers.get("content-type")?.includes("application/json")) eMsg = JSON.parse(txt).error || eMsg; else eMsg += `: ${txt.substring(0,100)}...`;} catch(e){} throw new Error(eMsg); }
                console.log("[5b] Attempting response.json()..."); const fetchedQuizData = await response.json(); console.log(`[6] Fetched quiz data (type: ${typeof fetchedQuizData}, length: ${Array.isArray(fetchedQuizData) ? fetchedQuizData.length : 'N/A'}):`, fetchedQuizData);
                if (!fetchedQuizData || !Array.isArray(fetchedQuizData) || fetchedQuizData.length === 0) { console.error("[7] Validation Failed!"); window.quizLogic.showError(`未能加载 Lesson ${lessonNumber} 词汇题。`); if (startLessonQuizBtn) startLessonQuizBtn.disabled = false; window.quizLogic.resetQuizStateVariables(); return; }
                window.currentQuizData = fetchedQuizData; console.log("[8] Global currentQuizData ASSIGNED");
                window.quizContext.question_ids = fetchedQuizData.map(q => q.id); console.log("[9] Context Q_IDs UPDATED:", window.quizContext.question_ids);
                console.log("[10] Calling displayQuestions..."); window.quizLogic.displayQuestions(fetchedQuizData);
            } catch (error) { console.error('[11] Error in startLessonQuizLocal:', error); window.quizLogic.showError(`开始测试失败: ${error.message}`); if (startLessonQuizBtn) startLessonQuizBtn.disabled = false; window.quizLogic.resetQuizStateVariables(); }
            finally { console.log("[12] finally block."); window.quizLogic.showLoading(false); }
        } // --- End startLessonQuizLocal ---

        // --- Function to restart THIS lesson's quiz ---
        function restartLessonQuizLocal() {
            console.log("lesson_text.html: Restarting quiz for this lesson...");
            window.quizLogic.resetQuizUI();
            if (startLessonQuizBtn) { startLessonQuizBtn.disabled = false; startLessonQuizBtn.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        }

        // --- Attach Event Listeners ---
        if (startLessonQuizBtn) {
            startLessonQuizBtn.addEventListener('click', () => { const lessonNum = startLessonQuizBtn.dataset.lessonNumber; startLessonQuizLocal(lessonNum); });
            console.log("Listener attached to #start-lesson-quiz-btn.");
        } else { console.warn("Start button not found."); }
        if (restartQuizBtn) {
            restartQuizBtn.addEventListener('click', restartLessonQuizLocal);
            console.log("Listener attached to #restart-quiz-btn.");
        } else { console.warn("Restart button not found."); }
        console.log("lesson_text.html: Submit listener handled by quiz_logic.js.");
    } // --- End of initializeLessonQuizLogic ---


    // ======================================
    // === Helper Function to Stop Media ===
    // ======================================
    function stopPlaybackAndRecording(recordBtn, preGenAudio, speakBtn) {
        console.log("Stopping other media...");
        // Stop pre-generated audio or recording playback
        if (currentAudioElement && typeof currentAudioElement.pause === 'function') {
            console.log("Pausing current audio element:", currentAudioElement);
            currentAudioElement.pause();
            currentAudioElement = null; // Clear reference
        }
        // Stop TTS
        if (window.speechSynthesis && window.speechSynthesis.speaking) {
            console.log("Stopping speech synthesis.");
            window.speechSynthesis.cancel(); // This should trigger its onend handler
            isCurrentlySpeaking = false;
            if(speakBtn) speakBtn.innerHTML = '<i class="bi bi-play-fill"></i> 朗读'; // Reset TTS button
        }
        // Stop Recording (if different from the element passed in, e.g., stopping recording when TTS starts)
        if (isCurrentlyRecording && mediaRecorderInstance && mediaRecorderInstance.state === 'recording') {
            console.log("Stopping ongoing recording.");
            stopRecording(recordBtn, document.getElementById('recording-status')); // Use helper
        }
    }

    // === Helper to stop media when another starts (e.g., when recorded audio plays) ===
    function stopOtherMedia(currentMediaElement, recordBtn, preGenAudio, speakBtn) {
        console.log("Stopping other media except current:", currentMediaElement);
         // Stop pre-generated audio if it's not the current one
         if (preGenAudio && currentMediaElement !== preGenAudio && !preGenAudio.paused) {
             console.log("Pausing pre-generated audio.");
             preGenAudio.pause();
         }
         // Stop TTS
         if (window.speechSynthesis && window.speechSynthesis.speaking) {
             console.log("Stopping speech synthesis.");
             window.speechSynthesis.cancel();
             isCurrentlySpeaking = false;
             if(speakBtn) speakBtn.innerHTML = '<i class="bi bi-play-fill"></i> 朗读';
         }
         // Stop Recording
         if (isCurrentlyRecording && mediaRecorderInstance && mediaRecorderInstance.state === 'recording') {
             console.log("Stopping ongoing recording.");
             stopRecording(recordBtn, document.getElementById('recording-status'));
         }
    }

     // ======================================
    // === Auxiliary Stop Recording Function ===
    // ======================================
    // This function ONLY signals the recorder to stop. The actual processing
    // happens in the 'onstop' event handler.
    function stopRecording(recordBtnElement, statusElement) {
         console.log("stopRecording helper called...");
         if (mediaRecorderInstance && mediaRecorderInstance.state === 'recording') {
             // Update UI immediately to 'stopping' state
             if(recordBtnElement) recordBtnElement.innerHTML = '<i class="bi bi-hourglass-split"></i> 停止中...';
             if(recordBtnElement) recordBtnElement.disabled = true;
             if(statusElement) statusElement.textContent = '处理录音中...';
             // isCurrentlyRecording will be set to false by updateRecordingUI in the onstop handler

             mediaRecorderInstance.stop(); // Trigger the onstop event
             console.log("mediaRecorder.stop() called.");
         } else {
             console.warn("stopRecording helper called but recorder not active or instance missing.");
             // Manually reset UI just in case it's stuck
             updateRecordingUI('idle'); // Defined within initializeRecordingLogic's scope
             // Ensure stream is stopped if somehow active without recorder
             if (mediaStreamInstance) {
                 mediaStreamInstance.getTracks().forEach(track => track.stop());
                 mediaStreamInstance = null;
             }
         }
    }


</script>
{% endblock %}