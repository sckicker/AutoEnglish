{# app/templates/lesson_text.html V1.9 - Improved Visuals #}
{% extends "base.html" %}
{% block title %}Lesson {{ lesson.lesson_number }} - {{ lesson.title_en or 'Lesson Text' }}{% endblock %}

{% block content %}
{# --- 1. æ ‡é¢˜åŒºåŸŸ (ä¿æŒä¸å˜æˆ–å¾®è°ƒæ ·å¼ç±») --- #}
{# å¯ä»¥è€ƒè™‘åœ¨è¿™é‡Œæ·»åŠ ä¸€äº›èƒŒæ™¯å›¾æˆ–æ›´ä¸°å¯Œçš„æ ·å¼ï¼Œä½†ä¸ºäº†ä¿æŒç®€æ´ï¼Œæˆ‘ä»¬ä¸»è¦ä¿®æ”¹bodyèƒŒæ™¯ #}
<div class="p-4 p-md-5 mb-4 rounded-3 bg-light shadow-sm border-start border-primary border-5">
    {# ... æ ‡é¢˜å†…å®¹ ... #}
    <div class="container-fluid py-3">
        <h1 class="display-5 fw-bold">Lesson {{ lesson.lesson_number }}: {{ lesson.title_en or 'Unknown Title' }}</h1>
        {% if lesson.title_cn %}
            <p class="fs-4 text-muted">{{ lesson.title_cn }}</p>
        {% endif %}
    </div>
</div>

{# --- 2. è‹±æ–‡è¯¾æ–‡ã€éŸ³é¢‘å’Œå½•éŸ³ä¸»åŒºåŸŸ (C ä½) --- #}
{# ä¿æŒ bg-white å’Œ shadowï¼Œè®©å†…å®¹åŒºåŸŸåœ¨æ–°çš„èƒŒæ™¯ä¸‹æ›´çªå‡º #}
<div class="p-4 border rounded-3 bg-white shadow mb-4">
    <h3 class="mb-4 pb-2 border-bottom"><i class="bi bi-file-earmark-text-fill"></i> è‹±æ–‡è¯¾æ–‡ä¸è·Ÿè¯»ç»ƒä¹ </h3>

    {# --- éŸ³é¢‘å’Œå½•éŸ³æ§ä»¶è¡Œ (ä¿æŒä¸å˜) --- #}
    <div class="row g-3 mb-4 align-items-center">
        {# é¢„ç”ŸæˆéŸ³é¢‘æ’­æ”¾å™¨ #}
        <div class="col-md-6">
            {% if audio_url %}
                <div>
                    <label class="form-label small fw-bold">è¯¾ç¨‹éŸ³é¢‘:</label>
                    <audio controls preload="metadata" class="w-100" title="æ’­æ”¾é¢„ç”Ÿæˆçš„è¯¾ç¨‹éŸ³é¢‘">
                        <source src="{{ audio_url }}" type="audio/wav">
                        ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒæ’­æ”¾ WAV éŸ³é¢‘ã€‚
                    </audio>
                </div>
            {% else %}
                <div class="text-muted small"><i class="bi bi-exclamation-circle"></i> æš‚æ— é¢„ç”ŸæˆéŸ³é¢‘ã€‚</div>
            {% endif %}
        </div>
        {# ç”¨æˆ·å½•éŸ³æ§ä»¶ #}
        <div class="col-md-6">
             <div class="p-3 border rounded-2 bg-light-subtle h-100">
                <label class="form-label small fw-bold">è·Ÿè¯»å½•éŸ³:</label>
                <div class="d-flex align-items-center mb-2">
                    <button id="record-button" class="btn btn-danger btn-sm me-2"><i class="bi bi-mic-fill"></i> å¼€å§‹å½•éŸ³</button>
                    <span id="recording-status" class="text-muted small flex-grow-1"></span>
                </div>
                <div id="user-recording-playback" style="min-height: 40px;"></div>
            </div>
        </div>
    </div>

    {# --- è‹±æ–‡è¯¾æ–‡å†…å®¹ --- #}
    <div class="lesson-text english-text preserve-newlines border-top pt-3" id="english-text-content">
        {# <h5 class="text-muted mb-3">Text Content:</h5> #}
        {% if lesson.text_en %}
            {# === ä¿®æ”¹ä¸ºï¼šç›´æ¥è¾“å‡ºåŸå§‹æ–‡æœ¬å†…å®¹ === #}
            {{ lesson.text_en }}
            {# ============================== #}
        {% else %}
            <p class="text-muted"><em>English text not available.</em></p>
        {% endif %}
    </div>
</div>
{# --- è‹±æ–‡åŒºåŸŸç»“æŸ --- #}

{# --- 3. æ“ä½œæŒ‰é’®åŒºåŸŸ (ä¿æŒä¸å˜) --- #}
<div class="mb-4 pt-3 text-center">
    <a href="{{ url_for('view_lessons') }}" class="btn btn-secondary me-2"><i class="bi bi-arrow-left-circle"></i> è¿”å›è¯¾ç¨‹åˆ—è¡¨</a>
    <button type="button" id="start-lesson-quiz-btn" class="btn btn-success" data-lesson-number="{{ lesson.lesson_number }}"><i class="bi bi-question-circle-fill"></i> æµ‹è¯•æœ¬è¯¾è¯æ±‡</button>
</div>

{# --- 4. éšè—çš„ Quiz å’Œ Results åŒºåŸŸ (ä¿æŒä¸å˜) --- #}
<div class="dynamic-content-area mt-4">
    <div id="quiz-area" class="hidden p-3 border rounded bg-light shadow-sm">...</div>
    <div id="results-area" class="hidden mt-4 p-3 border rounded bg-light shadow-sm">...</div>
    <div id="loading-indicator" class="hidden mt-4 text-center">...</div>
    <div id="error-message" class="alert alert-danger hidden mt-4" role="alert"></div>
</div>

{# --- 5. ä¸­æ–‡å‚è€ƒè¯‘æ–‡åŒºåŸŸ (ä¿®æ”¹ä¸ºé»˜è®¤æ˜¾ç¤º) --- #}
{% if lesson.text_cn %}
<hr class="my-4">
<div class="translation-section">
    {# ç§»é™¤äº†æ˜¾ç¤º/éšè—æŒ‰é’®çš„ <p> æ ‡ç­¾ #}
    {# <p><button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTranslation" aria-expanded="false" aria-controls="collapseTranslation"><i class="bi bi-translate"></i> æ˜¾ç¤º/éšè—å‚è€ƒè¯‘æ–‡</button></p> #}

    {# ä»åŒ…è£¹è¯‘æ–‡çš„ div ä¸­ç§»é™¤äº† 'collapse' ç±»ï¼Œä½¿å…¶é»˜è®¤æ˜¾ç¤º #}
    <div id="collapseTranslation"> {# ä¿æŒ IDï¼Œä½†ç§»é™¤ collapse ç±» #}
      <div class="card card-body bg-light border-secondary">
          <h5 class="card-title text-muted">å‚è€ƒè¯‘æ–‡ (Translation)</h5>
          <div class="lesson-text chinese-text preserve-newlines small">
                {% set cn_paragraphs = lesson.text_cn.split('\n') %}
                {% for para in cn_paragraphs %}{% if para.strip() %}<p class="mb-2">{{ para }}</p>{% endif %}{% endfor %}
          </div>
      </div>
    </div>
</div>
{% endif %}
{# --- ä¸­æ–‡åŒºåŸŸç»“æŸ --- #}
{% endblock %}

{% block styles_extra %}
<style>
    /* --- æ•´ä½“é¡µé¢èƒŒæ™¯ä¼˜åŒ– (ä¿æŒæˆ–æ ¹æ®éœ€è¦ä¿®æ”¹) --- */
    body {
        /* ç¤ºä¾‹: æŸ”å’Œçš„çº¿æ€§æ¸å˜èƒŒæ™¯ */
        background: linear-gradient(to bottom right, #e0f7fa, #b2ebf2);
        background-attachment: fixed; /* èƒŒæ™¯ä¸éšæ»šåŠ¨ç§»åŠ¨ */
    }

    /* --- å†…å®¹åŒºåŸŸå®¹å™¨çš„å¾®è°ƒ (å¢å¼ºé˜´å½±å’Œè¾¹æ¡†) --- */
     .rounded-3.bg-white.shadow,
     .rounded-3.bg-light.shadow-sm,
     .translation-section .card {
        box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1) !important; /* ç¨å¾®å¢å¼ºé˜´å½± */
        border-color: rgba(0, 0, 0, 0.08) !important; /* æŸ”å’Œçš„è¾¹æ¡†é¢œè‰² */
     }


    /* --- è‹±æ–‡è¯¾æ–‡åŒºåŸŸæ ·å¼è°ƒæ•´ - é€‰æ‹©ä¸€ä¸ªä¸»é¢˜å¹¶å–æ¶ˆæ³¨é‡Š --- */

    /* === ä¸»é¢˜ 1: æŸ”å’Œæ¸å˜è¾¹æ¡†ä¸çªå‡ºé˜´å½± === */
    /* è®©å†…å®¹åŒºåŸŸæ‹¥æœ‰ä¸€ä¸ªå¸¦æœ‰æ¸å˜æ•ˆæœçš„è¾¹æ¡†ï¼Œå¹¶å¢å¼ºé˜´å½± */
    /*
    .lesson-text.english-text {
        background-color: #ffffff; /* æµ…è‰²èƒŒæ™¯ */
        color: #333; /* æ·±è‰²æ–‡å­— */
        font-family: 'Lora', serif; /* ç¤ºä¾‹å­—ä½“ï¼Œè¯·ç¡®ä¿å¼•å…¥ */
        font-size: 1.15rem;
        line-height: 1.8;
        letter-spacing: 0.02em;
        padding: 2rem;

        border: 5px solid transparent; /* é€æ˜è¾¹æ¡†ï¼Œç”¨äº border-image */
        border-image: linear-gradient(to right, #007bff, #00c6ff) 1; /* çº¿æ€§æ¸å˜è¾¹æ¡† */
        border-image-slice: 1; /* ç¡®ä¿æ•´ä¸ªè¾¹æ¡†éƒ½åº”ç”¨æ¸å˜ */

        box-shadow: 0 1rem 2rem rgba(0, 123, 255, 0.2); /* å¸¦æœ‰ä¸»é¢˜è‰²çš„é˜´å½± */

        white-space: pre-line;
        position: relative;
        overflow: hidden;
        border-radius: 0.5rem; /* è¾¹æ¡†æ¸å˜å’Œåœ†è§’å¯èƒ½éœ€è¦è°ƒæ•´å…¼å®¹æ€§ */
    }
    */

    /* === ä¸»é¢˜ 2: ä¾§è¾¹å¼ºè°ƒçº¿ä¸æŸ”å’ŒèƒŒæ™¯ === */
    /* åœ¨å·¦ä¾§æ·»åŠ ä¸€æ¡æœ‰é¢œè‰²çš„å‚ç›´çº¿ï¼ŒèƒŒæ™¯æŸ”å’Œå¹²å‡€ */
    /*
    .lesson-text.english-text {
        background-color: #ffffff; /* å¹²å‡€çš„ç™½è‰²èƒŒæ™¯ */
        color: #444; /* æŸ”å’Œçš„æ·±ç°è‰²æ–‡å­— */
        font-family: 'Open Sans', sans-serif; /* ç¤ºä¾‹å­—ä½“ï¼Œè¯·ç¡®ä¿å¼•å…¥ */
        font-size: 1.1rem;
        line-height: 1.7;
        padding: 1.5rem 1.5rem 1.5rem 2rem; /* å·¦ä¾§ç•™æ›´å¤šç©ºé—´ç»™å¼ºè°ƒçº¿ */

        border-left: 5px solid #28a745; /* å·¦ä¾§ç»¿è‰²å¼ºè°ƒçº¿ */
        border-radius: 0.5rem;
        box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.05); /* æŸ”å’Œé˜´å½± */

        white-space: pre-line;
        position: relative;
        overflow: hidden;
    }
    */

    /* === ä¸»é¢˜ 3: æ‹Ÿç‰©åŒ–â€œçº¸å¼ â€æ•ˆæœ === */
    /* æ¨¡æ‹Ÿæ–‡æœ¬å†™åœ¨çº¸ä¸Šçš„æ•ˆæœï¼Œå¸¦æœ‰ subtle çš„çº¸å¼ çº¹ç†å’Œé˜´å½± */
    /* éœ€è¦ä¸€å¼ éå¸¸æµ…çš„çº¸å¼ çº¹ç†å›¾ç‰‡ï¼Œä¾‹å¦‚ paper_texture.png */
    .lesson-text.english-text {
        background-color: #fefefe; /* çº¸å¼ çš„é¢œè‰²ï¼Œå¯ä»¥ä¸æ˜¯çº¯ç™½ */
        background-image: url('{{ url_for("static", filename="images/lesson.png") }}'); /* çº¸å¼ çº¹ç† */
        background-repeat: repeat;
        background-size: auto;

        color: #222; /* æ¯”æ™®é€šæ·±è‰²æ–‡å­—æ›´æ·±ä¸€äº› */
        font-family: 'Playfair Display', serif; /* æ›´å…·è‰ºæœ¯æ„Ÿçš„å­—ä½“ */
        font-size: 1.15rem;
        line-height: 1.9; /* çº¸å¼ ä¸Šçš„è¡Œé«˜å¯ä»¥ç¨å¾®å¤§ä¸€ç‚¹ */
        letter-spacing: 0.03em; /* å­—æ¯é—´è·ä¹Ÿå¯ä»¥ç¨å¾®å¤§ä¸€ç‚¹ */

        padding: 2.5rem; /* çº¸å¼ è¾¹ç¼˜çš„ç•™ç™½ */

        border-radius: 8px; /* çº¸å¼ çš„åœ†è§’ */
        box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.15), 0 0 10px rgba(0, 0, 0, 0.05) inset; /* å¤–éƒ¨é˜´å½±å’Œ subtle çš„å†…éƒ¨é˜´å½± */

        white-space: pre-line;
        position: relative;
        overflow: hidden;
    }


    /* === é»˜è®¤/åŸºç¡€æ ·å¼ (å¦‚æœä¸Šé¢çš„ä¸»é¢˜éƒ½è¢«æ³¨é‡Šæ‰ï¼Œä½¿ç”¨è¿™ä¸ª) === */
    .lesson-text.english-text {
        background-color: #f8f9fa; /* Bootstrap çš„æµ…ç°è‰² */
        color: #212529; /* Bootstrap çš„é»˜è®¤æ·±è‰²æ–‡æœ¬ */
        font-family: 'Georgia', serif; /* ç¤ºä¾‹å­—ä½“ */
        font-size: 1.1rem;
        line-height: 1.7;
        padding: 1.5rem;
        white-space: pre-line;
        border-radius: 0.5rem; /* æ·»åŠ åœ†è§’ */
        box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.05); /* æ·»åŠ æŸ”å’Œé˜´å½± */
    }
    /* ======================================================= */


    /* --- ä¸­æ–‡å‚è€ƒè¯‘æ–‡æ ·å¼ (ä¿æŒæˆ–å¾®è°ƒ) --- */
    .chinese-text p {
        margin-bottom: 0.5em;
        line-height: 1.6;
    }

    /* --- å…¶ä»–æ ·å¼ (ä¿æŒæˆ–å¾®è°ƒ) --- */
    .translation-section .card-title { font-size: 1rem; }
    .border-5 { border-width: 5px !important; }
    .preserve-newlines { white-space: pre-line; }
    .dynamic-content-area { min-height: 200px; }
    .hidden { display: none; }
    .recording-indicator::before { content: 'ğŸ”´'; display: inline-block; margin-right: 5px; animation: blink 1.5s linear infinite; }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }


    /* å¼•å…¥ Web Font (ç¤ºä¾‹ï¼šå¼•å…¥ Lora å­—ä½“ï¼Œä½ éœ€è¦å°†å…¶æ”¾ç½®åœ¨ <base.html> çš„ <head> ä¸­æˆ–ä½¿ç”¨ @import) */
    /* ç¤ºä¾‹ï¼šåœ¨ base.html çš„ <head> ä¸­åŠ å…¥ç±»ä¼¼è¿™æ ·çš„æ ‡ç­¾ï¼Œæ ¹æ®ä½ é€‰æ‹©çš„å­—ä½“ä¿®æ”¹ */
    /* <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet"> */
    /* <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet"> */
    /* <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet"> */
    /* <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet"> */

</style>
{% endblock %}

{# --- ç‰¹å®šé¡µé¢ JS (ä¿æŒä¸å˜) --- #}
{% block scripts_extra %}
<script>
    // --- æµ‹éªŒå¯åŠ¨å’Œé‡å¯é€»è¾‘ (ä¿æŒä¸å˜) ---
    const startLessonQuizBtn = document.getElementById('start-lesson-quiz-btn');
    const restartQuizBtn = document.getElementById('restart-quiz-btn');

    async function startLessonQuiz(lessonNumber) { /* ... ä¹‹å‰çš„ startLessonQuiz å®ç° ... */ }
    function restartLessonQuiz() { /* ... ä¹‹å‰çš„ restartLessonQuiz å®ç° ... */ }

    if (startLessonQuizBtn) { startLessonQuizBtn.addEventListener('click', () => { /* ... */ }); }
    if (restartQuizBtn) { restartQuizBtn.addEventListener('click', restartLessonQuiz); }
    // ------------------------------------


    // === æ–°å¢ï¼šå½•éŸ³åŠŸèƒ½é€»è¾‘ (ä¿æŒä¸å˜) ===
    document.addEventListener('DOMContentLoaded', () => {
        const recordButton = document.getElementById('record-button');
        const recordingStatus = document.getElementById('recording-status');
        const userPlaybackDiv = document.getElementById('user-recording-playback');
        let mediaRecorder = null;
        let audioChunks = [];
        let audioStream = null; // Store the stream to stop tracks later
        let isRecording = false;
        let recordedAudioURL = null; // Store the URL for cleanup

        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia && window.MediaRecorder) {
            recordButton.addEventListener('click', async () => {
                if (isRecording) {
                    // --- åœæ­¢å½•éŸ³ ---
                    try {
                        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                            mediaRecorder.stop(); // onstop event will handle blob creation
                            // mediaRecorder ä¼šè‡ªåŠ¨åœæ­¢å…³è”çš„ track
                            // å¦‚æœéœ€è¦æ‰‹åŠ¨åœæ­¢æ‰€æœ‰è½¨é“ï¼ˆä¾‹å¦‚åœ¨å‡ºé”™æˆ–åˆ‡æ¢æ—¶ï¼‰
                            if (audioStream) {
                                audioStream.getTracks().forEach(track => track.stop());
                                console.log("Audio stream tracks stopped.");
                            }
                            console.log("Recording stopped via button.");
                        }
                         // UI æ›´æ–°å°†åœ¨ onstop äº‹ä»¶ä¸­å¤„ç†
                         recordingStatus.textContent = 'å¤„ç†ä¸­...';
                         recordingStatus.classList.remove('recording-indicator'); // ç§»é™¤é—ªçƒ
                         recordButton.disabled = true; // ç¦ç”¨ç›´åˆ°å¤„ç†å®Œæˆ

                    } catch (error) {
                         console.error("Error stopping recorder:", error);
                         recordingStatus.textContent = 'åœæ­¢å½•éŸ³å‡ºé”™';
                         // å°è¯•é‡ç½®çŠ¶æ€
                         isRecording = false;
                         recordButton.disabled = false;
                         recordButton.innerHTML = '<i class="bi bi-mic-fill"></i> å¼€å§‹å½•éŸ³';
                         recordButton.classList.replace('btn-secondary', 'btn-danger');
                    }

                } else {
                    // --- å¼€å§‹å½•éŸ³ ---
                    // æ¸…ç†ä¹‹å‰çš„å½•éŸ³ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    userPlaybackDiv.innerHTML = '';
                    if (recordedAudioURL) {
                        URL.revokeObjectURL(recordedAudioURL); // é‡Šæ”¾æ—§çš„ URL
                        recordedAudioURL = null;
                    }
                    audioChunks = []; // æ¸…ç©ºæ•°æ®å—

                    try {
                        recordingStatus.textContent = 'è¯·æ±‚éº¦å…‹é£æƒé™...';
                        // è¯·æ±‚éº¦å…‹é£æƒé™å¹¶è·å–éŸ³é¢‘æµ
                        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                        console.log("Microphone access granted.");
                        recordingStatus.textContent = 'å½•éŸ³ä¸­...';
                        recordingStatus.classList.add('recording-indicator'); // æ·»åŠ é—ªçƒæ•ˆæœ

                        // --- åˆå§‹åŒ– MediaRecorder ---
                        // å°è¯•æŒ‡å®š MIME ç±»å‹ä»¥è·å¾—æ›´å¥½çš„å…¼å®¹æ€§ï¼Œå¦‚ 'audio/webm', 'audio/ogg', 'audio/wav'
                        // æµè§ˆå™¨ä¼šé€‰æ‹©å®ƒæ”¯æŒçš„æœ€ä½³æ ¼å¼
                        const options = { mimeType: 'audio/wav' }; // å°è¯• WAV
                        try {
                            mediaRecorder = new MediaRecorder(audioStream, options);
                            console.log("Using mimeType:", options.mimeType);
                        } catch (e1) {
                            console.warn(`mimeType ${options.mimeType} not supported, trying default.`);
                            try {
                                 options.mimeType = 'audio/webm'; // å°è¯• WebM
                                 mediaRecorder = new MediaRecorder(audioStream, options);
                                 console.log("Using mimeType:", options.mimeType);
                            } catch(e2) {
                                console.warn(`mimeType ${options.mimeType} not supported, trying default.`);
                                try {
                                     options.mimeType = 'audio/ogg'; // å°è¯• Ogg
                                     mediaRecorder = new MediaRecorder(audioStream, options);
                                     console.log("Using mimeType:", options.mimeType);
                                } catch (e3) {
                                      console.warn("Could not set preferred mimeType, using browser default.");
                                      mediaRecorder = new MediaRecorder(audioStream); // ä½¿ç”¨æµè§ˆå™¨é»˜è®¤
                                }
                            }
                        }
                        // --------------------------

                        mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                audioChunks.push(event.data);
                                // console.log("Chunk received, size:", event.data.size); // Debug log
                            }
                        };

                        mediaRecorder.onstop = () => {
                            console.log("MediaRecorder stopped.");
                            recordingStatus.textContent = 'å½•éŸ³å®Œæˆã€‚';
                            recordingStatus.classList.remove('recording-indicator');

                            // åˆ›å»º Blob å’Œ URL
                            const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/wav' }); // ä½¿ç”¨è®°å½•æ—¶çš„MIMEç±»å‹æˆ–å›é€€
                             recordedAudioURL = URL.createObjectURL(audioBlob);
                            console.log("Blob created, URL:", recordedAudioURL);

                            // åˆ›å»ºæ’­æ”¾å™¨
                            const audioPlayer = document.createElement('audio');
                            audioPlayer.controls = true;
                            audioPlayer.preload = 'metadata'; // èŠ‚çœå¸¦å®½
                            audioPlayer.classList.add('w-100'); // Bootstrap width
                            const source = document.createElement('source');
                            source.src = recordedAudioURL;
                            source.type = audioBlob.type; // ä½¿ç”¨ Blob çš„ MIME ç±»å‹
                            audioPlayer.appendChild(source);
                            audioPlayer.onerror = () => { // æ·»åŠ æ’­æ”¾é”™è¯¯å¤„ç†
                                 console.error("Error playing recorded audio.");
                                 userPlaybackDiv.innerHTML = '<p class="text-danger small">æ— æ³•æ’­æ”¾å½•éŸ³ã€‚</p>';
                            };

                            userPlaybackDiv.innerHTML = ''; // æ¸…ç©ºæ—§çš„ï¼ˆå¦‚æœæœ‰ï¼‰
                            userPlaybackDiv.appendChild(audioPlayer);

                            // é‡ç½®æŒ‰é’®çŠ¶æ€
                            isRecording = false;
                            recordButton.disabled = false;
                            recordButton.innerHTML = '<i class="bi bi-mic-fill"></i> é‡æ–°å½•éŸ³'; // æç¤ºå¯ä»¥å†å½•
                            recordButton.classList.replace('btn-secondary', 'btn-danger');
                        };

                        mediaRecorder.onerror = (event) => {
                             console.error("MediaRecorder error:", event.error);
                             recordingStatus.textContent = `å½•éŸ³å‡ºé”™: ${event.error.name}`;
                             recordingStatus.classList.remove('recording-indicator');
                             isRecording = false;
                             recordButton.disabled = false;
                             recordButton.innerHTML = '<i class="bi bi-mic-fill"></i> å¼€å§‹å½•éŸ³';
                             recordButton.classList.replace('btn-secondary', 'btn-danger');
                        };

                        // å¼€å§‹å½•éŸ³
                        mediaRecorder.start();
                        console.log("Recording started.");
                        isRecording = true;
                        recordButton.innerHTML = '<i class="bi bi-stop-circle-fill"></i> åœæ­¢å½•éŸ³';
                        recordButton.classList.replace('btn-danger', 'btn-secondary'); // æ”¹å˜æŒ‰é’®é¢œè‰²

                    } catch (err) {
                        console.error("Error accessing microphone or starting recorder:", err);
                        recordingStatus.textContent = `æ— æ³•è®¿é—®éº¦å…‹é£: ${err.name}`;
                        alert(`é”™è¯¯ï¼šæ— æ³•è®¿é—®éº¦å…‹é£ã€‚\nè¯·ç¡®ä¿æ‚¨å·²æˆæƒæµè§ˆå™¨ä½¿ç”¨éº¦å…‹é£ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–åº”ç”¨æ­£åœ¨å ç”¨å®ƒã€‚\né”™è¯¯è¯¦æƒ…: ${err.message}`);
                        // é‡ç½®çŠ¶æ€
                        isRecording = false;
                        if (audioStream) { // å…³é—­å¯èƒ½å·²è·å–ä½†æœªä½¿ç”¨çš„æµ
                             audioStream.getTracks().forEach(track => track.stop());
                             audioStream = null;
                        }
                    }
                }
            });

        } else {
            // æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³ API
            console.error('Audio recording API not supported in this browser.');
            recordButton.disabled = true;
            recordingStatus.textContent = 'æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½';
            recordButton.title = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³';
            recordButton.innerHTML = '<i class="bi bi-mic-mute-fill"></i> æ— æ³•å½•éŸ³';
        }
    });
    // === ç»“æŸï¼šå½•éŸ³åŠŸèƒ½é€»è¾‘ ===

</script>
{% endblock %}