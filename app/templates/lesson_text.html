{# app/templates/lesson_text.html V1.3 - Fixed JS Declaration Error #}
{% extends "base.html" %} {# 继承基础模板 #}

{# 设置页面标题 #}
{% block title %}Lesson {{ lesson.lesson_number }} - {{ lesson.title_en or 'Lesson Text' }}{% endblock %}

{% block content %}
{# --- 1. 增强型标题区域 --- #}
<div class="p-4 p-md-5 mb-4 rounded-3 bg-light shadow-sm border-start border-primary border-5">
    <div class="container-fluid py-3">
        <h1 class="display-5 fw-bold">Lesson {{ lesson.lesson_number }}: {{ lesson.title_en or 'Unknown Title' }}</h1>
        {% if lesson.title_cn %}
            <p class="fs-4 text-muted">{{ lesson.title_cn }}</p>
        {% endif %}
    </div>
</div>

{# --- 2. 双栏对照区域 --- #}
<div class="row g-4">
    {# --- 左栏：英文课文 --- #}
    <div class="col-md-6">
        <div class="p-3 border rounded-2 bg-white h-100">
            <h4 class="mb-3 pb-2 border-bottom"><i class="bi bi-file-text"></i> 课文 (Text)</h4>
            {# --- 语音朗读控件 --- #}
            <div>
                <label for="voice-select" class="form-label small">选择语音:</label> {# Made label small #}
                <div class="input-group input-group-sm mb-2"> {# Use input group for better layout #}
                    <select id="voice-select" class="form-select form-select-sm"></select>
                    <button id="speak-button" class="btn btn-outline-primary"><i class="bi bi-play-fill"></i> 朗读</button>
                </div>
            </div>
            {# --- 英文课文内容 --- #}
            <div class="lesson-text english-text preserve-newlines" id="english-text-content"> {# Added ID for easier JS selection #}
                {% if lesson.text_en %}{{ lesson.text_en | safe }}{% else %}<p class="text-muted"><em>English text not available.</em></p>{% endif %}
            </div>
        </div>
    </div>
    {# --- 右栏：中文译文 --- #}
    <div class="col-md-6">
        {% if lesson.text_cn %}
            <div class="p-3 border rounded-2 bg-white h-100">
                <h4 class="mb-3 pb-2 border-bottom"><i class="bi bi-translate"></i> 参考译文 (Translation)</h4>
                <div class="lesson-text chinese-text preserve-newlines">
                    {# Process newlines for Chinese text as well #}
                    {% set cn_paragraphs = lesson.text_cn.split('\n') %}
                    {% for para in cn_paragraphs %}
                        {% if para.strip() %}<p>{{ para }}</p>{% endif %}
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="p-3 border rounded-2 bg-light h-100 d-flex align-items-center justify-content-center">
                 <p class="text-muted m-0"><em>Chinese translation not available.</em></p>
            </div>
        {% endif %}
    </div>
</div>

{# --- 3. 操作按钮区域 --- #}
<div class="mt-4 pt-3 text-center border-top"> {# 添加了 border-top 分隔 #}
    <a href="{{ url_for('view_lessons') }}" class="btn btn-secondary me-2"> {# Use view_lessons if that's the list page #}
        <i class="bi bi-arrow-left-circle"></i> 返回课程列表
    </a>
    {# --- 测试本课词汇按钮 (触发 JS) --- #}
    <button type="button" id="start-lesson-quiz-btn" class="btn btn-success" data-lesson-number="{{ lesson.lesson_number }}">
        <i class="bi bi-question-circle-fill"></i> 测试本课词汇 (Quiz this Lesson)
    </button>
    {# --- 按钮结束 --- #}
</div>

{# --- 4. 隐藏的 Quiz 和 Results 区域 (供 quiz_logic.js 使用) --- #}
<div class="dynamic-content-area mt-4"> {# 包裹动态区域 #}
    {# 测试题显示区域 (初始隐藏) #}
    <div id="quiz-area" class="hidden p-3 border rounded bg-light shadow-sm"> {# Added styles similar to results #}
        <h2 class="text-center mb-4">Lesson {{ lesson.lesson_number }} 词汇测试进行中...</h2>
        <div id="questions-container">
            {# Questions will be inserted here by JavaScript #}
        </div>
        <div class="text-center"> {# 居中提交按钮 #}
            <button type="button" id="submit-quiz-btn" class="btn btn-primary hidden mt-3">提交答案</button>
        </div>
    </div>

    {# 测试结果显示区域 (初始隐藏) #}
    <div id="results-area" class="hidden mt-4 p-3 border rounded bg-light shadow-sm">
        <h2>测试结果</h2>
        <p>你的得分: <span id="score" class="fw-bold"></span> / <span id="total-questions"></span></p>
        <h3 id="incorrect-title">错题回顾:</h3> {# Give title an ID if needed #}
        <ul id="incorrect-list" class="list-group list-group-flush mb-3">
            {# Incorrect answers will be inserted here #}
        </ul>
        {# 重新测试按钮 #}
        <button type="button" id="restart-quiz-btn" class="btn btn-info hidden">重新测试本课 (Quiz Again)</button>
    </div>

    {# 加载指示器 (初始隐藏) #}
    <div id="loading-indicator" class="hidden mt-4 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-2">请稍候...</p>
    </div>

    {# 错误消息显示区域 (初始隐藏) #}
     <div id="error-message" class="alert alert-danger hidden mt-4" role="alert"></div>
</div>
{# --- 隐藏区域结束 --- #}

{% endblock %}

{# --- 特定页面 CSS --- #}
{% block styles_extra %}
<style>
    .lesson-text { font-size: 1.05rem; line-height: 1.8; }
    /* .english-text { font-family: 'Times New Roman', Times, serif; } */
    .chinese-text p { margin-bottom: 0.8rem; } /* Adjust paragraph spacing for Chinese */
    .border-5 { border-width: 5px !important; }
    .preserve-newlines p { margin-bottom: 1em; } /* Ensure paragraphs have margin */
    /* Remove default margin for the first paragraph if needed */
    .preserve-newlines p:first-child { margin-top: 0; }
    .dynamic-content-area { min-height: 200px; }
    .hidden { display: none; } /* Ensure hidden class works */
</style>
{% endblock %}

{# --- 特定页面 JS (修正版) --- #}
{% block scripts_extra %}
<script>
    // console.log('lesson_text.html: Script block reached'); // Debug log

    // --- 语音合成部分 ---
    document.addEventListener('DOMContentLoaded', () => {
        if ('speechSynthesis' in window) {
            const synth = window.speechSynthesis;
            const voiceSelect = document.getElementById('voice-select');
            const textToSpeakElement = document.getElementById('english-text-content'); // Use ID
            const speakButton = document.getElementById('speak-button');
            let voices = [];

            function populateVoiceList() {
                try { // Add try-catch for robustness
                    voices = synth.getVoices();
                    voiceSelect.innerHTML = ''; // Clear existing options
                    voices.forEach(voice => {
                        // Optional: Filter for English voices if desired
                         if (voice.lang.startsWith('en')) {
                            const option = document.createElement('option');
                            option.textContent = `${voice.name} (${voice.lang})`;
                            option.value = voice.name; // Use name as value
                            option.setAttribute('data-lang', voice.lang); // Store lang if needed
                            voiceSelect.appendChild(option);
                        }
                    });
                    // Try to pre-select a default English voice if possible
                    const defaultVoice = voices.find(voice => voice.lang === 'en-US' && voice.default) || voices.find(voice => voice.lang === 'en-US') || voices.find(voice => voice.lang.startsWith('en'));
                    if(defaultVoice) voiceSelect.value = defaultVoice.name;

                } catch (e) {
                    console.error("Error populating voice list:", e);
                }
            }

            // Populate list initially and on change event
            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }

            if(speakButton && textToSpeakElement && voiceSelect) {
                speakButton.addEventListener('click', () => {
                    if (!textToSpeakElement.textContent) {
                         console.warn("No text content found to speak.");
                         return; // Don't speak if no text
                    }
                    if (synth.speaking) {
                        console.log("Speech synthesis is busy. Stopping previous utterance.");
                        synth.cancel(); // Stop previous speech before starting new
                         // Add a small delay before speaking again if needed
                        // setTimeout(() => speak(), 100);
                        // return;
                    }

                    const utterThis = new SpeechSynthesisUtterance(textToSpeakElement.textContent);
                    const selectedVoiceName = voiceSelect.value;
                    const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);

                    if (selectedVoice) {
                        utterThis.voice = selectedVoice;
                         utterThis.lang = selectedVoice.lang; // Set lang property
                        // console.log("Using voice:", selectedVoice.name); // Debug log
                    } else {
                        console.warn("Selected voice not found, using default.");
                    }

                    utterThis.onerror = (event) => { // Add error handling
                        console.error('SpeechSynthesisUtterance.onerror', event);
                        alert(`语音朗读出错: ${event.error}`);
                    };

                    synth.speak(utterThis);
                    // console.log("Speaking initiated."); // Debug log
                });
            } else {
                 console.warn("Speak button, text element, or voice select not found for speech synthesis setup.");
            }

        } else {
            console.error('Speech synthesis not supported in this browser.');
            const speakButton = document.getElementById('speak-button');
            const voiceSelect = document.getElementById('voice-select');
            if (speakButton) {
                speakButton.disabled = true;
                speakButton.title = '浏览器不支持语音朗读';
                speakButton.querySelector('i').classList.replace('bi-play-fill', 'bi-mic-mute'); // Change icon
            }
            if (voiceSelect) {
                voiceSelect.disabled = true;
            }
        }
    });

    // --- 测验逻辑交互部分 ---

    // Get references to BUTTONS specific to this page
    const startLessonQuizBtn = document.getElementById('start-lesson-quiz-btn');
    const restartQuizBtn = document.getElementById('restart-quiz-btn'); // In results area

    // --- Function to Initiate Quiz for THIS Lesson ---
    // This function will use the globally defined functions from quiz_logic.js
    async function startLessonQuiz(lessonNumber) {
        if (!lessonNumber) {
            console.error("startLessonQuiz called without a lessonNumber.");
            showError('无法获取课程编号。'); // Uses global showError
            return;
        }
        console.log(`Attempting to start quiz for lesson ${lessonNumber}...`);

        // Reset UI elements using global function before starting
        resetQuizUI(); // From quiz_logic.js - hides quiz/results, enables buttons etc.

        // Show loading and disable the start button for this page
        showLoading(true); // From quiz_logic.js
        if (startLessonQuizBtn) startLessonQuizBtn.disabled = true;

        // Define quiz parameters for this lesson
        const numQuestions = 10; // Or implement logic to get this (e.g., from user input if added)
        const quizType = 'cn_to_en'; // Or implement logic to get this

        // --- Set the global quizContext (defined in quiz_logic.js) ---
        quizContext = {
            lesson_ids: [parseInt(lessonNumber)], // Ensure it's an array of numbers
            quiz_type: quizType,
            question_ids: [] // Will be populated after fetching questions
        };
        console.log("Quiz context set:", quizContext);
        // -----------------------------------------------------------

        try {
            // Fetch quiz data using the API
            const response = await fetch(`/api/quiz?lessons=${lessonNumber}&count=${numQuestions}&type=${quizType}`);
            showLoading(false); // Hide loading AFTER fetch attempt

            if (!response.ok) {
                let errorMsg = `加载测验题目失败 (${response.status})`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.error || errorMsg;
                } catch (e) { /* Ignore if response not JSON */ }
                throw new Error(errorMsg);
            }

            // --- Set the global currentQuizData (defined in quiz_logic.js) ---
            currentQuizData = await response.json();
            // -----------------------------------------------------------------

            if (!currentQuizData || currentQuizData.length === 0) {
                showError(`未能加载 Lesson ${lessonNumber} 的词汇题。`); // Use global showError
                if (quizArea) quizArea.classList.add('hidden'); // Use global quizArea
                if (startLessonQuizBtn) startLessonQuizBtn.disabled = false; // Re-enable button
                return;
            }

            // --- Update quizContext with actual question IDs ---
            quizContext.question_ids = currentQuizData.map(q => q.id);
            console.log("Quiz data loaded, question IDs:", quizContext.question_ids);
            // -------------------------------------------------

            // Display the questions using global function
            displayQuestions(); // From quiz_logic.js

            // Ensure submit button is visible (it's controlled within displayQuestions too, but safety check)
            if (submitQuizBtn) submitQuizBtn.classList.remove('hidden'); // Use global submitQuizBtn

        } catch (error) {
            console.error('Error starting lesson quiz:', error);
            showError(`${error.message}`); // Use global showError
            if (quizArea) quizArea.classList.add('hidden'); // Use global quizArea
            if (startLessonQuizBtn) startLessonQuizBtn.disabled = false; // Re-enable button on error
            showLoading(false); // Ensure loading is hidden on error
        }
    }

    // --- Function to handle restarting THIS lesson's quiz ---
    function restartLessonQuiz() {
        console.log("Restarting quiz for this lesson...");
        // Reset the UI elements using global function
        resetQuizUI(); // From quiz_logic.js
        // The resetQuizUI function should re-enable the startLessonQuizBtn
        // User needs to click "测试本课词汇" again to start.
        // Alternatively, uncomment the line below to immediately restart:
        // if (startLessonQuizBtn && startLessonQuizBtn.dataset.lessonNumber) {
        //    startLessonQuiz(startLessonQuizBtn.dataset.lessonNumber);
        // }
    }

    // --- Attach Event Listeners for THIS page's buttons ---

    // Listener for the "测试本课词汇" button
    if (startLessonQuizBtn) {
        startLessonQuizBtn.addEventListener('click', () => {
            const lessonNum = startLessonQuizBtn.dataset.lessonNumber;
            startLessonQuiz(lessonNum); // Call the function defined above
        });
        console.log("Event listener attached to startLessonQuizBtn.");
    } else {
         console.warn("Start Lesson Quiz button (#start-lesson-quiz-btn) not found.");
    }

    // Listener for the "重新测试本课" button inside the results area
    if (restartQuizBtn) {
         restartQuizBtn.addEventListener('click', restartLessonQuiz); // Call the function defined above
         console.log("Event listener attached to restartQuizBtn.");
    } else {
         // This button might not exist until results are shown. Event delegation on resultsArea
         // might be more robust, but this direct approach works if the button ID is stable.
         console.warn("Restart button (#restart-quiz-btn) not found on initial load.");
    }

</script>
{% endblock %}